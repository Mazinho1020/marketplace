# üõ†Ô∏è **SISTEMA DE CONFIGURA√á√ïES - MARKETPLACE**

## **Documenta√ß√£o Completa do Sistema de Configura√ß√µes Multi-Site**

---

## üìã **VIS√ÉO GERAL**

O sistema de configura√ß√µes foi desenvolvido seguindo os padr√µes estabelecidos na **PADRONIZACAO_COMPLETA.md**, implementando:

-   ‚úÖ **Multitenancy** com `empresa_id`
-   ‚úÖ **Sincroniza√ß√£o** com `sync_hash`, `sync_status`, `sync_data`
-   ‚úÖ **SoftDeletes** em todas as tabelas
-   ‚úÖ **Timestamps** padr√£o Laravel (`created_at`, `updated_at`)
-   ‚úÖ **Nomenclatura snake_case** consistente
-   ‚úÖ **Relacionamentos** bem definidos
-   ‚úÖ **Scopes** para filtros por empresa

---

## üóÑÔ∏è **ESTRUTURA DO BANCO DE DADOS**

### **Tabelas Criadas:**

1. **`config_environments`** - Ambientes de execu√ß√£o (online/offline)
2. **`config_sites`** - Sites do marketplace (sistema, pdv, fidelidade, delivery)
3. **`config_groups`** - Grupos organizacionais de configura√ß√µes
4. **`config_definitions`** - Defini√ß√µes das configura√ß√µes dispon√≠veis
5. **`config_values`** - Valores das configura√ß√µes por contexto
6. **`config_history`** - Hist√≥rico de altera√ß√µes
7. **`config_roles`** - Pap√©is para controle de acesso
8. **`config_permissions`** - Permiss√µes de acesso √†s configura√ß√µes
9. **`config_url_mappings`** - Mapeamento de URLs por site/ambiente
10. **`config_db_connections`** - Conex√µes de banco por ambiente

### **Campos Obrigat√≥rios (Padroniza√ß√£o):**

```sql
-- Em TODAS as tabelas:
empresa_id          FOREIGN KEY to businesses
sync_hash           VARCHAR(64) NULLABLE
sync_status         ENUM('pending', 'synced', 'error') DEFAULT 'pending'
sync_data           TIMESTAMP NULLABLE
created_at          TIMESTAMP
updated_at          TIMESTAMP
deleted_at          TIMESTAMP NULLABLE (SoftDeletes)

-- √çndices obrigat√≥rios:
INDEX(empresa_id, sync_status)
```

---

## üèóÔ∏è **ARQUITETURA E FUNCIONAMENTO**

### **Hierarquia de Configura√ß√µes:**

O sistema implementa uma hierarquia de prioridades para resolver configura√ß√µes:

1. **Espec√≠fico** - Site espec√≠fico + Ambiente espec√≠fico
2. **Site Global** - Site espec√≠fico + Todos os ambientes
3. **Ambiente Global** - Todos os sites + Ambiente espec√≠fico
4. **Global** - Todos os sites + Todos os ambientes

### **Exemplo Pr√°tico:**

```php
// 1. Mais espec√≠fico (maior prioridade)
app_name para site='pdv' + environment='online' = "PDV Produ√ß√£o"

// 2. Site espec√≠fico
app_name para site='pdv' + environment=NULL = "PDV Sistema"

// 3. Ambiente espec√≠fico
app_name para site=NULL + environment='online' = "Marketplace Produ√ß√£o"

// 4. Global (menor prioridade)
app_name para site=NULL + environment=NULL = "Marketplace"
```

---

## üíª **COMO USAR O SISTEMA**

### **1. Via Helper Function (Recomendado)**

```php
// Obter configura√ß√£o
$appName = config_marketplace('app_name');
$companyName = config_marketplace('empresa_nome', 'Empresa Padr√£o');

// Obter grupo de configura√ß√µes
$telegramConfigs = config_marketplace()->getGroup('telegram');

// Definir configura√ß√£o
config_marketplace()->set('app_name', 'Novo Nome', $siteId, $environmentId);
```

### **2. Via Inje√ß√£o de Depend√™ncia**

```php
use App\Services\Config\ConfigManager;

class ExemploController extends Controller
{
    public function __construct(private ConfigManager $configManager)
    {
    }

    public function exemplo()
    {
        $valor = $this->configManager->get('chave_config');
        $this->configManager->set('nova_chave', 'valor', $siteId, $environmentId);
    }
}
```

### **3. Via Facade (Se configurado)**

```php
use App\Services\Config\ConfigManager;

$manager = app(ConfigManager::class);
$value = $manager->get('app_name');
```

---

## üñ•Ô∏è **INTERFACE ADMINISTRATIVA**

### **Rotas Dispon√≠veis:**

```php
// Listar todas as configura√ß√µes
GET /admin/config

// Criar nova configura√ß√£o
GET /admin/config/create
POST /admin/config

// Editar configura√ß√£o
GET /admin/config/{id}/edit
PUT /admin/config/{id}

// Remover configura√ß√£o
DELETE /admin/config/{id}

// Visualizar por grupo
GET /admin/config/group/{groupCode}

// Definir valor via AJAX
POST /admin/config/set-value

// Limpar cache
POST /admin/config/clear-cache

// Exportar configura√ß√µes
GET /admin/config/export

// Hist√≥rico de altera√ß√µes
GET /admin/config/{id}/history
```

### **Filtros Dispon√≠veis:**

-   Por grupo de configura√ß√£o
-   Por site espec√≠fico
-   Por ambiente espec√≠fico
-   Busca por chave ou descri√ß√£o

---

## ‚å®Ô∏è **LINHA DE COMANDO (CLI)**

### **Comando Artisan:**

```bash
# Obter configura√ß√£o
php artisan config:manage get app_name

# Definir configura√ß√£o global
php artisan config:manage set empresa_nome "Minha Empresa"

# Definir configura√ß√£o espec√≠fica para site
php artisan config:manage set app_name "PDV Nome" --site=pdv

# Definir configura√ß√£o espec√≠fica para ambiente
php artisan config:manage set debug true --environment=offline

# Listar todas as configura√ß√µes
php artisan config:manage list

# Listar configura√ß√µes de um grupo
php artisan config:manage list --group=telegram

# Limpar cache
php artisan config:manage clear-cache

# Usar empresa espec√≠fica
php artisan config:manage get app_name --empresa=2
```

---

## üéØ **GRUPOS DE CONFIGURA√á√ÉO PADR√ÉO**

### **1. Grupo 'geral'**

-   `app_name` - Nome da aplica√ß√£o
-   `app_author` - Autor da aplica√ß√£o
-   `app_email` - Email de contato
-   `app_version` - Vers√£o do sistema
-   `debug` - Modo de depura√ß√£o

### **2. Grupo 'empresa'**

-   `empresa_nome` - Nome da empresa
-   `empresa_cnpj` - CNPJ da empresa
-   `empresa_telefone` - Telefone da empresa
-   `empresa_endereco` - Endere√ßo da empresa

### **3. Grupo 'telegram'**

-   `telegram_token` - Token do bot
-   `telegram_chat_id` - ID do chat
-   `telegram_api_url` - URL da API
-   `telegram_message` - Mensagem padr√£o

### **4. Grupo 'sync'**

-   `sync_interval_minutes` - Intervalo de sincroniza√ß√£o
-   `sync_auto_on_startup` - Sincronizar ao iniciar
-   `sync_backup_local` - Backup local antes de sincronizar
-   `export_dir` - Diret√≥rio de exporta√ß√£o
-   `import_dir` - Diret√≥rio de importa√ß√£o
-   `backup_dir` - Diret√≥rio de backup
-   `log_dir` - Diret√≥rio de logs

### **5. Grupo 'fidelidade'**

-   `fidelidade_ativo` - Sistema de fidelidade ativo
-   `fidelidade_percentual_cashback` - Percentual de cashback padr√£o
-   `fidelidade_min_compra_cashback` - Valor m√≠nimo para ganhar cashback
-   `fidelidade_max_cashback_dia` - Valor m√°ximo de cashback por dia

### **6. Grupo 'pdv'**

-   `pdv_ativo` - PDV ativo
-   `pdv_impressora_automatica` - Impress√£o autom√°tica de cupons
-   `pdv_desconto_maximo` - Desconto m√°ximo permitido (%)

---

## üöÄ **INSTALA√á√ÉO E CONFIGURA√á√ÉO**

### **1. Executar Migration:**

```bash
php artisan migrate
```

### **2. Executar Seeder:**

```bash
php artisan db:seed --class=ConfigSeeder
```

### **3. Registrar Service Provider (se necess√°rio):**

```php
// config/app.php
'providers' => [
    // ...
    App\Providers\ConfigServiceProvider::class,
];
```

### **4. Incluir Rotas:**

```php
// routes/web.php
require __DIR__.'/admin_config.php';
```

---

## üîí **SEGURAN√áA E PERMISS√ïES**

### **Sistema de Roles:**

-   `admin` - Acesso total √†s configura√ß√µes
-   `gerente` - Acesso restrito √†s configura√ß√µes
-   `operador` - Apenas leitura

### **Valida√ß√µes:**

-   Chaves seguem padr√£o `snake_case`
-   Valores s√£o validados conforme tipo definido
-   Apenas usu√°rios autorizados podem editar
-   Hist√≥rico completo de altera√ß√µes

### **Multitenancy:**

-   Todas as opera√ß√µes s√£o filtradas por `empresa_id`
-   Usu√°rios s√≥ veem configura√ß√µes de sua empresa
-   Isolamento completo entre empresas

---

## üìà **RECURSOS AVAN√áADOS**

### **Cache Inteligente:**

-   Cache autom√°tico por contexto (empresa + site + ambiente)
-   Invalida√ß√£o autom√°tica ao alterar valores
-   Controle manual de cache via interface e CLI

### **Sincroniza√ß√£o:**

-   Todos os registros possuem campos de sincroniza√ß√£o
-   Status autom√°tico de 'pending' ao alterar
-   M√©todos para marcar como sincronizado/erro

### **Auditoria:**

-   Hist√≥rico completo de altera√ß√µes
-   Registro de usu√°rio, IP e user-agent
-   Rastreamento de valores anteriores e novos

### **Import/Export:**

-   Exporta√ß√£o de configura√ß√µes em JSON
-   Backup autom√°tico antes de altera√ß√µes
-   Restore de configura√ß√µes por timestamp

---

## üîß **EXEMPLOS DE USO PR√ÅTICO**

### **Configura√ß√£o Espec√≠fica por Site:**

```php
// Definir nome diferente para cada site
config_marketplace()->set('app_name', 'Sistema Administrativo', $sitesSistema->id);
config_marketplace()->set('app_name', 'PDV Loja', $sitesPdv->id);
config_marketplace()->set('app_name', 'Fidelidade', $sitesFidelidade->id);

// Obter nome baseado no site atual (detectado automaticamente)
$appName = config_marketplace('app_name'); // Retorna o nome espec√≠fico do site atual
```

### **Configura√ß√£o por Ambiente:**

```php
// Debug apenas em desenvolvimento
config_marketplace()->set('debug', true, null, $environmentOffline->id);
config_marketplace()->set('debug', false, null, $environmentOnline->id);
```

### **Configura√ß√£o de Fidelidade por Site:**

```php
// Diferentes percentuais de cashback por loja
config_marketplace()->set('fidelidade_percentual_cashback', '2.5', $loja1->id);
config_marketplace()->set('fidelidade_percentual_cashback', '3.0', $loja2->id);
config_marketplace()->set('fidelidade_percentual_cashback', '1.5', $loja3->id);
```

---

## üé® **INTEGRA√á√ÉO COM FRONTEND (Theme Hyper)**

### **Blade Templates:**

```blade
{{-- Obter configura√ß√µes no Blade --}}
<h1>{{ config_marketplace('app_name') }}</h1>
<p>Empresa: {{ config_marketplace('empresa_nome') }}</p>

{{-- Verificar se recurso est√° ativo --}}
@if(config_marketplace('fidelidade_ativo'))
    <div class="alert alert-success">
        <i class="uil uil-star me-1"></i>
        Sistema de Fidelidade Ativo
    </div>
@endif
```

### **JavaScript/AJAX:**

```javascript
// Alterar configura√ß√£o via AJAX
function updateConfig(configId, valor, siteId = null, ambienteId = null) {
    fetch("/admin/config/set-value", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRF-TOKEN": document.querySelector('meta[name="csrf-token"]')
                .content,
        },
        body: JSON.stringify({
            config_id: configId,
            valor: valor,
            site_id: siteId,
            ambiente_id: ambienteId,
        }),
    })
        .then((response) => response.json())
        .then((data) => {
            if (data.success) {
                showSuccess(data.message);
            } else {
                showError(data.message);
            }
        });
}
```

---

## üìö **REFER√äNCIAS E PADR√ïES**

-   **Documento Base:** `PADRONIZACAO_COMPLETA.md`
-   **Nomenclatura:** snake_case para campos do banco
-   **Framework:** Laravel 9+ com Eloquent ORM
-   **Frontend:** Theme Hyper (Bootstrap 5)
-   **Multitenancy:** Campo `empresa_id` obrigat√≥rio
-   **Sincroniza√ß√£o:** Campos `sync_hash`, `sync_status`, `sync_data`
-   **Soft Deletes:** Campo `deleted_at` em todas as tabelas

---

Este sistema de configura√ß√µes est√° completamente alinhado com os padr√µes estabelecidos e pronto para uso em produ√ß√£o! üöÄ
