<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="csrf-token" content="{{ csrf_token() }}" />
    <title>Teste Busca de Produtos</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container py-5">
      <h1>üîç Teste Busca de Produtos</h1>

      <div class="row">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5>Busca Manual (AJAX)</h5>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label for="termoBusca" class="form-label"
                  >Digite o termo de busca:</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="termoBusca"
                  placeholder="Nome ou SKU do produto"
                />
              </div>
              <button type="button" class="btn btn-primary" id="btnBuscar">
                üîç Buscar
              </button>
              <div id="resultados" class="mt-3"></div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5>Log de Debug</h5>
            </div>
            <div class="card-body">
              <div
                id="debugLog"
                class="border p-3 bg-dark text-light"
                style="height: 300px; overflow-y: auto; font-family: monospace"
              >
                <div class="text-success">[INFO] Sistema iniciado</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      const debugLog = document.getElementById("debugLog");

      function log(message, type = "INFO") {
        const timestamp = new Date().toLocaleTimeString();
        const colorClass =
          {
            INFO: "text-info",
            SUCCESS: "text-success",
            WARNING: "text-warning",
            ERROR: "text-danger",
          }[type] || "text-light";

        const div = document.createElement("div");
        div.className = colorClass;
        div.textContent = `[${timestamp}] [${type}] ${message}`;
        debugLog.appendChild(div);
        debugLog.scrollTop = debugLog.scrollHeight;
      }

      $(document).ready(function () {
        log("jQuery carregado");
        log("CSRF Token: " + $('meta[name="csrf-token"]').attr("content"));

        // URL da busca - ajustar conforme necess√°rio
        const produtoId = 8; // ID do produto para teste
        const buscarUrl = `/marketplace/public/comerciantes/produtos/${produtoId}/relacionados/buscar`;
        log("URL de busca: " + buscarUrl);

        $("#btnBuscar").click(function () {
          const termo = $("#termoBusca").val().trim();

          if (termo.length < 2) {
            log("Termo muito curto (m√≠nimo 2 caracteres)", "WARNING");
            return;
          }

          log("Iniciando busca para: " + termo);
          $("#resultados").html(
            '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Buscando...</div>'
          );

          $.ajax({
            url: buscarUrl,
            method: "GET",
            dataType: "json",
            headers: {
              "X-CSRF-TOKEN": $('meta[name="csrf-token"]').attr("content"),
              "X-Requested-With": "XMLHttpRequest",
            },
            data: {
              q: termo,
            },
            success: function (response) {
              log("Busca bem-sucedida", "SUCCESS");
              log("Resposta: " + JSON.stringify(response));

              if (response.results && response.results.length > 0) {
                let html = '<div class="list-group">';
                response.results.forEach(function (produto) {
                  html += `<div class="list-group-item">
                                    <strong>ID:</strong> ${produto.id}<br>
                                    <strong>Texto:</strong> ${produto.text}
                                </div>`;
                });
                html += "</div>";
                $("#resultados").html(html);
              } else {
                $("#resultados").html(
                  '<div class="alert alert-info">Nenhum produto encontrado</div>'
                );
              }
            },
            error: function (xhr, status, error) {
              log(
                "Erro na busca: " + xhr.status + " - " + xhr.statusText,
                "ERROR"
              );
              log("Resposta: " + xhr.responseText, "ERROR");

              $("#resultados").html(`
                            <div class="alert alert-danger">
                                <strong>Erro ${xhr.status}:</strong> ${xhr.statusText}<br>
                                <small>Verifique o console para mais detalhes</small>
                            </div>
                        `);
            },
          });
        });

        // Buscar ao pressionar Enter
        $("#termoBusca").keypress(function (e) {
          if (e.which === 13) {
            $("#btnBuscar").click();
          }
        });
      });
    </script>
  </body>
</html>
